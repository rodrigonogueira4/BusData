<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
        <script type="text/javascript" src="d3.v2.js"></script>
        <script type="text/javascript" src="jquery.min.js"></script>     

        <link rel="stylesheet" type="text/css" href="jquery.datepick.css"> 
        <script type="text/javascript" src="jquery.plugin.js"></script> 
        <script type="text/javascript" src="jquery.datepick.min.js"></script>
        <link rel="stylesheet" type="text/css" href="outlier.css"> 
    </head>
    <body>
        <div style="width: 1600px;">
            <div style="width: 400px;height: 800px;float: left;">
                <div style="width: 400px;height: 70px;float: left;">
                    <font size="5">RioBusData</font>
                    <br>
                    <font size="3">Visualization of Outlier Buses in the City Rio de Janeiro</font>
                </div>
                <div id="sortLineBarChartDiv">
                    <!--<button type="button" id="btnSort" style="width:285px;" onclick="changeSortLineBarChart()">Sort by number of outliers</button>-->
                    <input type="checkbox" id="sortLineBarChart" onchange="changeSortLineBarChart()" />
                    <label for="sortLineBarChart">Sort by number of outliers</label>
                </div>
                <div class="barchartDiv">
                    <svg class="barchart"></svg>
                </div>
                <div id="busesOfLine"></div>

            </div>
            <!---<center>
                <div id="dayChartDiv">
                    <svg id="dayBarchart"></svg>
                </div>
            </center>-->
            <div style="margin-left: 10px;width: 1150px;height: 800px;float: left;">
                <div style="width: 100%; height: 800px; overflow: hidden;">

                    <div style="width: 670px;height: 200px;float: left;">
                        <div id="multiInlinePicker" ></div>
                    </div>
                    <div style="width: 450px;height: 200px;float: left;">
                        <svg id="timeBarchart"></svg>
                    </div>
                    <div >
                        <div id="map" style="height: 800px"></div>
                    </div> 
                </div>
            </div>
        </div>
        <div style="width: 100%; overflow: hidden;">
                <svg id="tripchart" width="1000" height="350"></svg>
        </div>    
        <div id="outlierinfo"></div>
    </body>

    <script type="text/javascript">
        var maxPts = 2000;
        var outliersfileArray = [];
        var outliersperdayfile = "number_of_outliers_per_day.csv";
        var outliersperdaylinefile = "number_of_outliers_per_day_line.csv";
        var outliersperdayhourlinefile = "number_of_outliers_per_day_hour_line.csv";
        var dateFileArray = [];
		var outliersDict = {};
        var startHour;
        var startMinute;
        var endHour;
        var endMinute;
        var selectedOutlier;
        var sortLineBarChartByNumberOfOutliers = false;
        var MAX_DIST = (0.003); //maximum distance to 2 pts be considered close. 1 degree latitude = 100km. 1 meter = 0.00001 degrees. 100 meters = 0.001
        var RIO_CENTER_LAT = -22.911773;
        var RIO_CENTER_LONG = -43.230199;
        var listOfOutlierBuses = [];
        var overlay_outliers = new google.maps.OverlayView();
        var outlier_data;
        var outlier_data_layer;
        var overlay_raw = new google.maps.OverlayView();
        var raw_data;
        var raw_data_layer;
        var raw_data_load_callback_count;
        var selectedLines = [];
        var selectedHours = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}; //all hours selected
        var selectedBusId = ""; 
        var min_latitude_bounding = null;
        var max_latitude_bounding = null;
        var min_longitude_bounding = null;
        var max_longitude_bounding = null;
    </script>
    <script type="text/javascript">
        $("#outlierinfo").hide(); //start info box invisible
        
        $('#multiInlinePicker').datepick({ 
            multiSelect: 30, monthsToShow: 3, monthsToStep: 1, 
            defaultDate: '10/05/2013',
			showOtherMonths: true,
            prevText: 'Prev month', nextText: 'Next month'
            //onSelect:function(date){
            //}
          });
        
        $('#multiInlinePicker').click(function() {
            date = $('#multiInlinePicker').datepick('getDate');
                
            outliersfileArray = [];
            dateFileArray = [];
            for (var i = 0; i < date.length; i++){
                datei = date[i];
                day = datei.getDate();
                month = datei.getMonth() + 1;
                year = datei.getFullYear();
                dateFile = day + "-" + month +  "-" + year;
                dateFileArray.push(dateFile);
                outliersfile = "outliers/" + day + "_" + month + ".csv";
                outliersfileArray.push(outliersfile);   
            }
			loadedDict();
            loadTimeBarChart();
            loadLstLines();
            selectedBusId = "";
            selectedLines = [];
            loadPtsOutliers(true);
        })
    </script>   
    <script type="text/javascript">

    //Trip Time Chart
    var vis = d3.select("#tripchart"),
            WIDTH = 100,
            HEIGHT = 300,
            MARGINS = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 80
            },
            xScale = d3.scale.linear().range([MARGINS.left, WIDTH - MARGINS.right]).domain([0.0, 1.0]),
            yScale = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0,600]),
            xAxis = d3.svg.axis()
                      .scale(xScale),
            yAxis = d3.svg.axis()
                      .scale(yScale)
                      .orient("left");
    
        //vis.append("svg:g")
        //  .attr("class","axis")
        //   .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
        //   .call(xAxis);
        vis.append("svg:g")
           .attr("class","axis")
           .attr("transform", "translate(" + (MARGINS.left) + ", " + (0) + ")")
           .call(yAxis);
        
        //Create Y axis label   
        vis.append("svg:text")
        .attr("x", -150 )
        .attr("y",  25 )
        .style("text-anchor", "middle")
        .attr("transform", "rotate(-90)")
        .text("Trip Time (in minutes)");
        
        function parseDate(datestr) {
            return Date.parse(datestr.substring(0, 19).replace(" ", "T"));
        }

        // Create the Google Map
        var stylez = [
            {
              featureType: "all",
              elementType: "all",
              stylers: [
                { saturation: -100 }, // <-- THIS SETS TO GRAYSCALE
                { visibility: "off" }
              ]
            },
            {
                featureType: "road",
                stylers: [
                    { visibility: "on" }
                ]
            }
        ];

        var mapOptions = {
            zoom: 9,
            center: new google.maps.LatLng(RIO_CENTER_LAT, RIO_CENTER_LONG),
            mapTypeControlOptions: {
                 mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'tehgrayz']
            },
        };

        map = new google.maps.Map(d3.select("#map").node(), mapOptions);
        var mapType = new google.maps.StyledMapType(stylez, { name:"Grayscale" });    
        map.mapTypes.set('tehgrayz', mapType);
        map.setMapTypeId('tehgrayz');

		//paint calendar
		calendarColorMap();
		
		var daysCount = Object.keys(outliersDict).length;
		var min_outlier_value = -1;
		var max_outlier_value = -1;
		
		function calendarColorMap(){
			var first_october = 6432;
			var first_november = 33216;
			var third_november = 34980;
			var first_december = 59172;
			var offset = 864;
			var prefix = "dp138";
			var suffix = "00000";

			for (var i=0; i<31; i++)
			{
				if ((first_october + i * offset) >= 10000)
					outliersDict["10/" + (i+1)] = [prefix + (first_october + i * offset) + suffix, 0];
				else
					outliersDict["10/" + (i+1)] = [prefix + "0" + (first_october + i * offset) + suffix, 0];				
				
				if (i<30)
				{
					if (i<2)
						outliersDict["11/" + (i+1)] = [prefix + (first_november + i * offset) + suffix, 0];
					else
						outliersDict["11/" + (i+1)] = [prefix + (third_november + (i-2) * offset) + suffix, 0];					
				}
				
				outliersDict["12/" + (i+1)] = [prefix + (first_december + i * offset) + suffix, 0];
			}
		
			daysCount = Object.keys(outliersDict).length;
			min_outlier_value = -1;
			max_outlier_value = -1;

			loadDay();
		}
		function loadDay()
		{
			d3.csv("number_of_outliers_per_day.csv", function(data) {
				for (key in outliersDict)
				{
					for (var i=0; i<data.length; i++)
					{
						if (key == data[i]["Date"])
						{
							outliersDict[key][1] = +data[i]["NumberOfOutliers"];
							if (min_outlier_value == -1 || outliersDict[key][1] < min_outlier_value)
							{
								min_outlier_value = outliersDict[key][1];
							}
							if (max_outlier_value == -1 || outliersDict[key][1] > max_outlier_value)
							{
								max_outlier_value = outliersDict[key][1];
							}
							break;
						}
					}
				}
				loadedDict();
			});

		}
		var hsv2rgb = function(h, s, v) {
			// adapted from http://schinckel.net/2012/01/10/hsv-to-rgb-in-javascript/
			var rgb, i, data = [];
			if (s === 0) {
				rgb = [v,v,v];
			}
			else {
				h = h / 60;
				i = Math.floor(h);
				data = [v*(1-s), v*(1-s*(h-i)), v*(1-s*(1-(h-i)))];
				switch(i) {
				  case 0:
					rgb = [v, data[2], data[0]];
					break;
				  case 1:
					rgb = [data[1], v, data[0]];
					break;
				  case 2:
					rgb = [data[0], v, data[2]];
					break;
				  case 3:
					rgb = [data[0], data[1], v];
					break;
				  case 4:
					rgb = [data[2], data[0], v];
					break;
				  default:
					rgb = [v, data[0], data[1]];
					break;
				}
			}
			return '#' + rgb.map(function(x){
				return ("0" + Math.round(x*255).toString(16)).slice(-2);
			}).join('');
		}
	
		function loadedDict()
		{
			var color;
			for (key in outliersDict)
			{
				if (outliersDict[key][1] > 0)
				{
				//$("." + outliersDict[key][0]).css({"background-color" : "rgba(255,0,0," + outliersDict[key][1] / max_outlier_value + ")"});
				//$("." + outliersDict[key][0]).css({"background-color" : "rgba(255,0,0," + ((outliersDict[key][1] / max_outlier_value) * 0.7) + ")"});
					color = hsv2rgb(Math.floor((100 - ((outliersDict[key][1] / max_outlier_value) * 100)) * 120 / 100), Math.abs((((outliersDict[key][1] / max_outlier_value) * 100) - 50) / 50), 1);
					$("." + outliersDict[key][0]).css({"background-color" : color});
				}
			}
		}
		
        // Load the raw data. When the data comes back, create an overlay.        
        overlay_raw.onAdd = function() {
            raw_data_layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
                                                                          .attr("class", "rawpt");
        };
        
        var raw_markers = [];
        overlay_raw.draw = function() {
            var projection = this.getProjection(),
            padding = 10;

            var marker = raw_data_layer.selectAll("svg")
                              .data(d3.entries(raw_data))
                              .each(transform) // update existing markers
                              .enter().append("svg:svg")
                              .each(transform)
                              .attr("class", "marker");

            // Add a circle.
            raw_markers.push(marker.append("svg:circle"));
            raw_markers[raw_markers.length - 1]
                  .attr("r", 3.0)
                  .attr("cx", padding)
                  .attr("cy", padding);
            
            function transform(d) {
                d2 = new google.maps.LatLng(+d.value[9], +d.value[10]);
                d2 = projection.fromLatLngToDivPixel(d2);
                return d3.select(this)
                         .style("left", (d2.x - padding) + "px")
                         .style("top", (d2.y - padding) + "px");
            }
        };
        overlay_raw.onRemove = function() {
            $(".rawpt").remove();
            raw_markers = [];
        };
        
        function loadPtsRaw(redrawPoints, reloadIndividualBuses) {
            if (redrawPoints)
            {
                overlay_raw.setMap(null);
                raw_data = [];
                raw_data_load_callback_count = selectedLines.length;
            }
            
            for (i=0; i < selectedLines.length; i++) {
                var full_data = [];
                var count = dateFileArray.length;
                
                for (var k=0; k<dateFileArray.length; k++)
                {
                    d3.text("data_separated_by_line_and_day/" + selectedLines[i] + "/" + dateFileArray[k], function(text) {
						if (text != null)
						{
							temp_data = d3.csv.parseRows(text);
							temp_data.shift();
							full_data.push(temp_data);
						}
						if (!--count) loadData();
                    });
                }
                
                function loadData() {
                    raw_data = [];
                    for (var j=0; j<full_data.length; j++)
                    {
                        raw_data = raw_data.concat(full_data[j]);
                    }
                    //do sampling
                    var samplingRate = Math.floor(raw_data.length/maxPts);
                    if (samplingRate < 1) {
                        samplingRate = 1;
                    }
                    raw_data = raw_data.filter(function(row,index) { 
                        if (index % samplingRate != 0) {
                            return false;
                        }
                        return true;
                    });
                    
                    //filter by start date and end date
                    raw_data = raw_data.filter(function(row,index) {
                        //convert to standard format
                        timestamp = row[11].substring(0, 10) + "T" + row[11].substring(10, 18) + "+0000"
                        return containsHour(timestamp);
                    });   
                    var listOfBuses = []
                    
                    raw_data.filter(function(row,index) {    
                        if (listOfBuses.indexOf(row[3]) == -1)
                            listOfBuses.push(row[3]);
                    });
                    
                    if (reloadIndividualBuses){
                        var div_list = document.getElementById("busesOfLine");
                        div_list.innerHTML = "";
                        
                        for (var i=0; i<listOfBuses.length; i++)
                        {
                            if (listOfOutlierBuses.indexOf(listOfBuses[i]) != -1)
                            {
                                var div = document.createElement("div");
                                div_list.appendChild(div);
                                div.id = "divBus" + listOfBuses[i];
                                div.innerHTML = listOfBuses[i];
                                div.style.color = "white";
                                div.style.border = "0px solid white";
                                div.style.marginBottom = "2px";
                                div.style.marginLeft = "2px";
                                div.style.marginRight = "2px";
                                div.style.textAlign = "center";
                                div.style.opacity = 0.5;
                                if (listOfOutlierBuses.indexOf(listOfBuses[i]) != -1){
                                    div.style.background = "red";
                                    div.className = "busOutlierDiv";
                                }else{
                                    div.style.background = "blue";
                                    div.className = "busDiv";
                                }                            
                            }
                        }
                        
                        $(".busDiv").hover(function() {
                            $(this).css("background", "green");
                        });

                        $(".busOutlierDiv").hover(function() {
                            $(this).css("opacity", 1.0);
                        });
                        
                        $(".busDiv").mouseout(function() {
                            $(this).css("background", "steelblue");
                        });

                        $(".busOutlierDiv").mouseout(function() {
                            if (!($(this).hasClass("busselected")))
                                $(this).css("opacity", 0.4);
                        });
                        
                        $(".busOutlierDiv").click(function() {
                            var busid = $(this).html();
                            selectBus(busid);
                          
                        });
                        
                        //load trip-time chart. It must be inside the loadptsraw because the raw points are only loaded in the end of the function.
                        loadTripTimes(listOfOutlierBuses);
                    }

                    for (idx in raw_data) {
                        if (min_latitude_bounding == null || min_latitude_bounding > raw_data[idx][9])
                            min_latitude_bounding = raw_data[idx][9];
                        if (max_latitude_bounding == null || max_latitude_bounding < raw_data[idx][9])
                            max_latitude_bounding = raw_data[idx][9];
                        if (min_longitude_bounding == null || min_longitude_bounding > raw_data[idx][10])
                            min_longitude_bounding = raw_data[idx][10];
                        if (max_longitude_bounding == null || max_longitude_bounding < raw_data[idx][10])
                            max_longitude_bounding = raw_data[idx][10];
                    }                             
          
                    if (redrawPoints){
                        raw_data_load_callback();
                    }
                   
                };
            }
        }
        //var rectangle;
        var bounds = new google.maps.LatLngBounds();
        function raw_data_load_callback() {
            raw_data_load_callback_count = raw_data_load_callback_count - 1;
            if (raw_data_load_callback_count == 0)
                overlay_raw.setMap(map);
            
            bounds = new google.maps.LatLngBounds();
            bounds.extend(new google.maps.LatLng(+max_latitude_bounding, +max_longitude_bounding));
            bounds.extend(new google.maps.LatLng(+min_latitude_bounding, +min_longitude_bounding));
            map.setCenter(new google.maps.LatLng((+min_latitude_bounding + +max_latitude_bounding)/2, (+min_longitude_bounding + +max_longitude_bounding)/2));
            map.fitBounds(bounds);
        }
        
        overlay_outliers.onAdd = function() {
            //remove all previous layers.
            myNode = this.getPanes().overlayMouseTarget;
            while (myNode.firstChild) {
                myNode.removeChild(myNode.firstChild);
            }

            outlier_data_layer = d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class", "outliers");
        };
        
        var outlier_markers = [];
		var projection;

        overlay_outliers.draw = function() {
            projection = this.getProjection(),
            padding = 10;
            
            var tooltip = d3.select("body")
                            .append("div")
                            .style("position", "absolute")
                            .style("z-index", "10")
                            .style("visibility", "hidden");
                            //.text("a simple tooltip");
            
            var marker = outlier_data_layer.selectAll("svg")
                                           .data(d3.entries(outlier_data))
                                           .each(
                                              function (d) {
                                                d = new google.maps.LatLng(+d.value['LatitudePonto'], +d.value['LongitudePonto']);
                                                d = projection.fromLatLngToDivPixel(d);
                                                return d3.select(this)
                                                  .style("left", (d.x - padding) + "px")
                                                  .style("top", (d.y - padding) + "px");
                                              }
                                           )
                                          .style("width", "14px")
                                          .style("height", "14px")
                                           .enter().append("svg:svg")
                                           .each(
                                              function (d) {
                                                d = new google.maps.LatLng(+d.value['LatitudePonto'], +d.value['LongitudePonto']);
                                                d = projection.fromLatLngToDivPixel(d);
                                                return d3.select(this)
                                                  .style("left", (d.x - padding) + "px")
                                                  .style("top", (d.y - padding) + "px");
                                              }
                                           )
                                           .style("width", "14px")
                                           .style("height", "14px")
                                           .style("z-index", 20)
                                           .attr("class", "marker")
                                           .on("click", function(d, i) {selectBus(d.value["BusId"]);});
            // Add a circle.
            outlier_markers.push(marker.append("svg:circle"));
            outlier_markers[outlier_markers.length - 1]
                  .attr("r", 4.0)
                  .attr("cx", padding)
                  .attr("cy", padding);
            
            $(".marker2").remove();
			if (selectedBusId != "") {
				addOutlierPath();
            }
        };
    
        overlay_outliers.onRemove = function() {
            $(".outliers").remove();
            outlier_markers = [];
        };
		
		function addOutlierPath()
		{
			var outlier_data_filtered = outlier_data.filter(function(row,index) {
				if (row['BusId'] == selectedBusId) {
					return true;
				}
				return false;
			});
			var marker = outlier_data_layer.selectAll("svg2")
								   .data(d3.entries(outlier_data_filtered))
								   .style("z-index", 1)
								   .each(
									  function (d) {
										d1 = new google.maps.LatLng(+d.value['LatitudePonto'], +d.value['LongitudePonto']);
										d1 = projection.fromLatLngToDivPixel(d1);
										 d2 = new google.maps.LatLng(+d.value['LatitudePontoPrevious'], +d.value['LongitudePontoPrevious']); 
										 d2 = projection.fromLatLngToDivPixel(d2);
										 var minx = Math.min(d1.x, d2.x);
										 var miny = Math.min(d1.y, d2.y);
										return d3.select(this)
										  .style("left", (minx) + "px")
										  .style("top", (miny) + "px");
									  }
								   )
								   .enter().append("svg:svg")
								   .each(
									  function (d) {
										d1 = new google.maps.LatLng(+d.value['LatitudePonto'], +d.value['LongitudePonto']);
										d1 = projection.fromLatLngToDivPixel(d1);
										 d2 = new google.maps.LatLng(+d.value['LatitudePontoPrevious'], +d.value['LongitudePontoPrevious']); 
										 d2 = projection.fromLatLngToDivPixel(d2);
										 var minx = Math.min(d1.x, d2.x);
										 var miny = Math.min(d1.y, d2.y);
										return d3.select(this)
										  .style("left", (minx) + "px")
										  .style("top", (miny) + "px");
									  }
								   )
								   .attr("class", "marker2");
			marker.append("svg:line")
				  .attr("class", "connectionline")
				  .attr("x1", 0)
				  .attr("y1", function (d) {     d1 = new google.maps.LatLng(+d.value['LatitudePonto'], +d.value['LongitudePonto']);
												 d1 = projection.fromLatLngToDivPixel(d1);
												 d2 = new google.maps.LatLng(+d.value['LatitudePontoPrevious'], +d.value['LongitudePontoPrevious']); 
												 d2 = projection.fromLatLngToDivPixel(d2);
												 if (d1.x>d2.x){
													 return d2.y - Math.min(d1.y,d2.y);
												 }else{
													 return d1.y - Math.min(d1.y,d2.y);
												 }
											  })
				  .attr("x2", function (d) {     d1 = new google.maps.LatLng(+d.value['LatitudePonto'], +d.value['LongitudePonto']);
												 d1 = projection.fromLatLngToDivPixel(d1);
												 d2 = new google.maps.LatLng(+d.value['LatitudePontoPrevious'], +d.value['LongitudePontoPrevious']); 
												 d2 = projection.fromLatLngToDivPixel(d2);
												 var minx = Math.min(d1.x, d2.x);
												 var maxx = Math.max(d1.x, d2.x);
												 return maxx-minx;
											  })
				  .attr("y2", function (d) {     d1 = new google.maps.LatLng(+d.value['LatitudePonto'], +d.value['LongitudePonto']);
												 d1 = projection.fromLatLngToDivPixel(d1);
												 d2 = new google.maps.LatLng(+d.value['LatitudePontoPrevious'], +d.value['LongitudePontoPrevious']); 
												 d2 = projection.fromLatLngToDivPixel(d2);
												 if (d1.x>d2.x){
													 return d1.y - Math.min(d1.y,d2.y);
												 }else{
													 return d2.y - Math.min(d1.y,d2.y);
												 }
											  });
		}

        function loadOutliersPerDay() {
            var barchart_data = [];
            d3.csv(outliersperdayfile, function(data) {
                data.forEach(function(d) {
                    barchart_data.push({key: d.Date, number_of_outliers: d.NumberOfOutliers});
                });

                var barWidth = 40;
                var height = 179;

                var y = d3.scale.linear()
                    .domain([0, d3.max(barchart_data, function(d) { return Math.log(d.number_of_outliers)*1.05; })])
                    .range([0, height]);

                var chart = d3.select("#dayBarchart")
                                .attr("width", barWidth * barchart_data.length)
                                .attr("height", height);

                var bar = chart.selectAll("g")
                                .data(barchart_data)
                                .enter().append("g")
                                .attr("transform", function(d, i) { return "translate(" + i * barWidth + "," + (height - y(Math.log(d.number_of_outliers))) + ")"; });
                               
                bar.append("rect")
                    .attr("height",  function(d) { return y(d.number_of_outliers); })
                    .attr("width", barWidth - 1)
                    .on("click", function(d, i) {selectDay(d, this);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this).style({opacity: '0.6'});
                                        })
                    .on("mouseout", function(d, i) {
                                        d3.select(this).style({opacity: '1.0'});
                                     });

                bar.append("text")
                    .attr("x", barWidth / 2)
                    .attr("y", function (d) { y(Math.log(d.number_of_outliers)); })
                    .attr("dx", "1em")
                    .attr("transform", function(d) { return "translate(0, " + (y(Math.log(d.number_of_outliers)) - 3) + ")"; })
                    .text(function(d) { return d.key; })
                    .on("click", function(d, i) {selectDay(d, this);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '0.6'});
                                        })
                    .on("mouseout", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '1.0'});
                                     });
                
                bar.append("text")
                    .attr("x", barWidth / 2)
                    .attr("y", function (d) { y(d.number_of_outliers); })
                    .attr("dx", ".8em")
                    .text(function(d) { return d.number_of_outliers; })
                    .on("click", function(d, i) {selectDay(d, this);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '0.6'});
                                        })
                    .on("mouseout", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '1.0'});
                                     });
            });
        }
        
        
        function loadTimeBarChart() {
            
            
            d3.csv(outliersperdayhourlinefile, function(data) {
                var timebarchart_data_dic = {};
                data.forEach(function(d) {
                    if (!(d.Hour in timebarchart_data_dic)){
                        timebarchart_data_dic[d.Hour] = 0    
                    }
                    datestr = (d.Day.toString()+ "-" + d.Month.toString() + "-" + d.Year.toString());
                    if ( (dateFileArray.indexOf(datestr) != -1) || dateFileArray.length == 0){ //check date 
                        if ( (selectedLines.indexOf(d.Line) != -1) || selectedLines.length == 0){ //check line
                            timebarchart_data_dic[d.Hour] += +d.NumberOfOutliers;
                        }
                    }
                });
                //convert to list
                var timebarchart_data = [];
                for (var hour in timebarchart_data_dic) {
                    timebarchart_data.push({key: hour, number_of_outliers: timebarchart_data_dic[hour]});
                }
                barWidth = 20;
                height = 192;

                var y = d3.scale.linear()
                    .domain([0, d3.max(timebarchart_data, function(d) { return d.number_of_outliers*1.05; })])
                    .range([0, height]);

                var timechart = d3.select("#timeBarchart")
                                .attr("width", barWidth * timebarchart_data.length)
                                .attr("height", height);
                timechart.selectAll("g").remove(); //remove all bars
                
                var timebar = timechart.selectAll("g")
                                .data(timebarchart_data)
                                .enter().append("g")
                                .attr("transform", function(d, i) { return "translate(" + i * barWidth + "," + (height - y(d.number_of_outliers)) + ")"; });
                
                timebar.append("rect")
                    .attr("height",  function(d) { return y(d.number_of_outliers); })
                    .attr("width", barWidth - 1)
                    .on("click", function(d, i) {selectTime(d.key);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this).style({opacity: '0.8'});
                                        })
                    .on("mouseout", function(d, i) {
                                        d3.select(this).style({opacity: '1.0'});
                                     });
                
                timebar.append("text")
                    .attr("x", barWidth / 2)
                    .attr("y", function (d) { y(d.number_of_outliers); })
                    .attr("dx", "0.5em")
                    .attr("transform", function(d) { return "translate(0, " + (y(d.number_of_outliers) - 3) + ")"; })
                    .text(function(d) { return d.key; })
                    .on("click", function(d, i) {selectTime(d.key);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '0.6'});
                                        })
                    .on("mouseout", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '1.0'});
                                     });
                
                timebar.append("text")
                    .attr("x", barWidth / 2)
                    .attr("y", function (d) { y(d.number_of_outliers); })
                    .attr("dx", ".8em")
                    .text(function(d) { return d.number_of_outliers; })
                    .on("click", function(d, i) {selectTime(d.key);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '0.6'});
                                        })
                    .on("mouseout", function(d, i) {
                                       d3.select(this.parentNode).select("rect").style({opacity: '1.0'});
                                   });
               colorTimeBars();
            });
            
            
        }
        
        
        function loadTripTimes(outlierBuses) {
            chart = d3.select("#tripchart");
            chart.selectAll(".dotraw").remove(); //remove all dots in the chart
            chart.selectAll(".dotoutlier").remove(); //remove all dots in the chart
            chart.selectAll(".xlabel").remove(); //remove X labels
            outlierBuses2 = ["All"].concat(outlierBuses);
                
            //group trips by bus and trip
            trips = [];
            bus_dir = {};
            max_trip_time = 0;
			var min_trip_time = -1;
            outlier_trips = {};
            j = 0;
            for (idx in raw_data) {
                bus_id = raw_data[idx][3];
                timestamp = new Date(raw_data[idx][11].substring(0, 10) + "T" + raw_data[idx][11].substring(10, 18) + "+0000");
                trip_time = +raw_data[idx][13];
                direction = raw_data[idx][14];
                if (!(bus_id in bus_dir)){
                    bus_dir[bus_id] = "";
                }
                if (direction != bus_dir[bus_id]){
                    trips.push([bus_id, trip_time, direction]);
                    bus_dir[bus_id] = direction;
                    if (trip_time > max_trip_time){
                        max_trip_time = trip_time;
                    }
					if (min_trip_time == -1 || min_trip_time > trip_time)
						min_trip_time = trip_time;
                    j += 1;
                }
                
                //check if this is an outlier
                for (idx2 in outlier_data){
                    timeStampOut = new Date(outlier_data[idx2].TimeStamp.substring(0, 19).replace(" ", "T")+ "+0000");
                    busIdOut = outlier_data[idx2].BusId;
                    if (busIdOut == bus_id){
                        if (timeStampOut.getTime() == timestamp.getTime()){
                            outlier_trips[j] = 0;    
                        }
                    }
                }
            }
	
			yScale.domain([Math.floor(min_trip_time), Math.ceil(max_trip_time)]);
			
			chart.select(".axis")
				 .transition().duration(1500)
				 .call(yAxis);
			
            for (i in outlierBuses2){
                for (idx in trips) {
                    trip_bus_id = trips[idx][0];
                    
                    /*if(trip_bus_id == outlierBuses2[i]) {
                        chart.append('svg:circle')
                        .attr("class", "dot")
                        .attr("r", 4.5)
                        .attr("cy", 275-(trip_time/4))
                        .attr("cx", 100 + 80*i)
                        .on("mouseover", function(d, i) { d3.select(this).html("bla").style({"visibility": "visible"});})
                        .on("mouseout", function(d, i) { d3.select(this).html("bla").style({"visibility": "hidden"});})
                        .style("opacity", "1.0")
                        .style("fill", "red"); */
                    
                    if(trip_bus_id == outlierBuses2[i] || outlierBuses2[i] == "All") {
                        trip_time = trips[idx][1];
                        dotclass = "dotraw";
                        if (idx in outlier_trips){
                            dotclass = "dotoutlier";
                        }
						
                        chart.append('svg:circle')
							.attr("class", dotclass)
							.attr("r", 4.5)
							.attr("cy", yScale(trip_time))
							//.attr("cy", 275-(trip_time/4))
							.attr("cx", 100 + 80*i);
                    }
                }
                
                //Create X axis label   
                chart.append("svg:text")
                    .attr("x", 100 + 80*i )
                    .attr("y",  320 )
                    .attr("class", "xlabel")
                    .style("text-anchor", "middle")
                    .attr("font-size", "12px")
                    .text(outlierBuses2[i]);
				
				//var y = d3.scale.linear().domain([0,100]);
				//var yAxis = d3.svg.axis().scale(y);
				
				//chart.yAxis.scale().domain([0,100]);
            }
            
        }
        function loadPtsOutliers(redrawPoints) {
            
            $("#outlierinfo").hide(); //hide selected oulier div
            
            if (redrawPoints){
                overlay_outliers.setMap(null);
                outlier_data = null;
                
                min_latitude_bounding = null;
                max_latitude_bounding = null;
                min_longitude_bounding = null;
                max_longitude_bounding = null;
            }

            var full_data = [];
            //if no date was selected, subsample days
            var dates = [];
            if (outliersfileArray.length == 0){
                datesdist = []
                d3.csv(outliersperdayfile, function(data) {
                     data.forEach(function(d) {
                        for (i=0;i<d.NumberOfOutliers;i++){
                            datesdist.push(d.Date);
                        }
                    });
                    for (i = 0;i < 5; i++){//subsample 5 days
                        idx = Math.floor((Math.random() * datesdist.length) + 1);
                        monthday = datesdist[idx].split("/")
                        dates.push("outliers/" + monthday[1] + "_" + monthday[0] + ".csv");
                    }
                    loaddays();
                });
                
            }else{
                dates = outliersfileArray;
                loaddays();
            }
            
            function loaddays(){
                var count = dates.length;
                for (var i=0; i<dates.length; i++){
                    d3.csv(dates[i], function(temp_data) {
                        full_data.push(temp_data);        
                        if (!--count) loadData();
                    });
                }
            }
            function loadData() {
                var data = [];
                for (var j=0; j<full_data.length; j++)
                {
                    data = data.concat(full_data[j]);
                }

                data = data.filter(function(row,index) {
                    var contains = false;
                    if (selectedLines.length == 0){ //if no lines were selected, select all
                        contains = true;
                    }else{
                        for (i in selectedLines) {
                            if (row['Linha'] == selectedLines[i]) {
                                contains = true;
                            }
                        }
                    }
                    return contains;
                });
                outlier_data = []; 
                k = 0;
                
                //pts must be structured as rows
                for (row in data) {
                    var minreftime = parseDate(data[row]['TimeStamp_19']); 
                    var maxreftime = parseDate(data[row]['TimeStamp_0']); 
     
                    for (i = 19; i>=0; i--){
                        var timestamp = parseDate(data[row]['TimeStamp_' + i]);
                      
                        if (i>=1){
                            var TimeStampPrevious = data[row]['TimeStamp_'+(i-1)];
                            var LatPrevious = data[row]['LatitudePonto_'+(i-1)];
                            var LongPrevious = data[row]['LongitudePonto_'+(i-1)];
                        }else{
                            var TimeStampPrevious = data[row]['TimeStamp_'+i];
                            var LatPrevious = data[row]['LatitudePonto_'+i];
                            var LongPrevious = data[row]['LongitudePonto_'+i];
                        }
                        outlier_data[k] = {
                            TimeStampStart:data[row]['TimeStamp_19'].substring(0, 19),
                            TimeStampEnd:data[row]['TimeStamp_0'].substring(0, 19),
                            TimeStamp:data[row]['TimeStamp_'+i],
                            LatitudePonto:data[row]['LatitudePonto_'+i],
                            LatStart:data[row]['LatitudePonto_19'],
                            LongStart:data[row]['LongitudePonto_19'],
                            LatEnd:data[row]['LatitudePonto_0'],
                            LongEnd:data[row]['LongitudePonto_0'],
                            LongitudePonto:data[row]['LongitudePonto_'+i],
                            TimeStampPrevious: TimeStampPrevious,
                            LatitudePontoPrevious:LatPrevious,
                            LongitudePontoPrevious:LongPrevious,
                            Speed:data[row]['Speed_'+i],
                            row:row,
                            BusId:data[row]["Onibus"],
                            Line:data[row]["Linha"]
                        };
                        if (min_latitude_bounding == null || min_latitude_bounding > outlier_data[k]['LatitudePonto'])
                            min_latitude_bounding = outlier_data[k]['LatitudePonto'];
                        if (max_latitude_bounding == null || max_latitude_bounding < outlier_data[k]['LatitudePonto'])
                            max_latitude_bounding = outlier_data[k]['LatitudePonto'];
                        if (min_longitude_bounding == null || min_longitude_bounding > outlier_data[k]['LongitudePonto'])
                            min_longitude_bounding = outlier_data[k]['LongitudePonto'];
                        if (max_longitude_bounding == null || max_longitude_bounding < outlier_data[k]['LongitudePonto'])
                            max_longitude_bounding = outlier_data[k]['LongitudePonto'];
                        k = k + 1;
                    } 
                }
           
                //do sampling
                var samplingRate = Math.floor(outlier_data.length/maxPts);

                if (samplingRate < 1){
                    samplingRate = 1;
                }
                outlier_data = outlier_data.filter(function(row,index) { 
                    if (index % samplingRate != 0) {
                        return false;
                    }
                    return true;
                }); 
            
                //filter by start date
                outlier_data = outlier_data.filter(function(row,index) {
                    return containsHour(row["TimeStamp"]);
                });
                
                listOfOutlierBuses = []
                    
                outlier_data.filter(function(row,index) {
                    if (listOfOutlierBuses.indexOf(row["BusId"]) == -1)
                        listOfOutlierBuses.push(row["BusId"]);
                });
                
                
                /*
                if(busID == "") {
                  //set the selected outlier var with the first point of the first outlier. Its timestamp and coordinates will be used so select raw points in the temporal chart
                  selectedOutlier = outlier_data[0];
                } else{
                  for(row in outlier_data) {
                    if (outlier_data[row]["BusId"] == busID){
                      selectedOutlier = outlier_data[row];
                      break;
                    }
                  }
                }
                 
                //remove duplicated outliers
                var startTimeAbs = new Date(selectedOutlier.TimeStampStart.substring(0, 19).replace(" ", "T")+ "+0000");
                var endTimeAbs = new Date(selectedOutlier.TimeStampEnd.substring(0, 19).replace(" ", "T")+ "+0000");
                var startTime = new Date(2000, 0, 0, startTimeAbs.getHours(), startTimeAbs.getMinutes(), 0, 0);
                var endTime = new Date(2000, 0, 0, endTimeAbs.getHours(), endTimeAbs.getMinutes(), 0, 0);
                outlier_data_by_bus = {};
                outlier_data_by_bus2 = {};
                
                for (row in outlier_data) {
                    if (outlier_data[row]["BusId"] == selectedOutlier["BusId"]){
                        if (!((outlier_data[row]["BusId"]+outlier_data[row]["TimeStamp"]) in outlier_data_by_bus)){
                              outlier_data_by_bus[outlier_data[row]["BusId"]+outlier_data[row]["TimeStamp"]] = 1;
                              if (!(outlier_data[row]["BusId"] in outlier_data_by_bus2)){
                                  outlier_data_by_bus2[outlier_data[row]["BusId"]] = [];
                              }
                              outlier_data_by_bus2[outlier_data[row]["BusId"]].push(outlier_data[row]);

                              //update start and end dates of the selected outlier    
                              var tsAbs = new Date(outlier_data[row]["TimeStamp"].substring(0, 19).replace(" ", "T")+ "+0000");
                              var ts = new Date(2000, 0, 0, tsAbs.getHours(), tsAbs.getMinutes(), 0, 0);
                          
                              if (ts <= startTime){
                                  startTime = ts;
                                  selectedOutlier.TimeStampStart = outlier_data[row]["TimeStamp"];
                                  selectedOutlier.LatStart = outlier_data[row]["LatitudePonto"];
                                  selectedOutlier.LongStart = outlier_data[row]["LongitudePonto"];
                              }
                              if (ts >= endTime){
                                  endTime = ts;
                                  selectedOutlier.TimeStampEnd = outlier_data[row]["TimeStamp"];
                                  selectedOutlier.LatEnd = outlier_data[row]["LatitudePonto"];
                                  selectedOutlier.LongEnd = outlier_data[row]["LongitudePonto"];
                              }
                        }
                    }    
                }*/
                
                if (redrawPoints){
                    overlay_outliers.setMap(map);
                    loadPtsRaw(true, true);
                }
                
            }
        }
        
        function sortByNumberOfOutliers(a, b) {
            if (a.number_of_outliers < b.number_of_outliers)
                return 1;
            if (a.number_of_outliers > b.number_of_outliers)
                return -1;
            
            return 0;
        }
        
        function sortByLabel(a, b){
            var temp_a = Number(a.key);
            var temp_b = Number(b.key);
            
            if (temp_a < temp_b)
                return -1;
            if (temp_a > temp_b)
                return 1;
            
            return 0;
        }
    
        function changeSortLineBarChart(){
            if (sortLineBarChartByNumberOfOutliers){
                sortLineBarChartByNumberOfOutliers = false;
                //$("#btnSort").html('Sort by number of outliers');
            }else{
                sortLineBarChartByNumberOfOutliers = true;
                //$("#btnSort").html('Sort by line name');
            }
            loadLstLines();
        }
    
        function loadLstLines() {
            //first, remove all existing bars in the bar chart
            d3.select(".barchart").selectAll("g").remove();
            loadPtsOutliers(true);
            
            d3.csv(outliersperdaylinefile, function(data) {
                lines_outliers = {};
                for (row in data){
                    if (dateFileArray.length == 0){
                        num_outliers = +data[row]['NumberOfOutliers'];
                    }else{
                        num_outliers = 0;
                        for (i in dateFileArray){
                            dates = dateFileArray[i].split("-");
                            day = +dates[0];
                            month = +dates[1];
                            year = +dates[2];
                            if (+data[row]['Year'] == year && +data[row]['Month'] == month && +data[row]['Day'] == day){
                              num_outliers += +data[row]['NumberOfOutliers'];
                            }
                        }
                    }
                    if (!(data[row]['Line'] in lines_outliers)){
                        lines_outliers[data[row]['Line']] = 0;
                    }
                    lines_outliers[data[row]['Line']] += num_outliers;
                    
                }               
                var barchart_data = [];
                for (line in lines_outliers){
                    if (lines_outliers[line] > 0){
                        barchart_data.push({key: line, number_of_outliers: lines_outliers[line]});
                    }
                }
                
                if (sortLineBarChartByNumberOfOutliers)
                    barchart_data.sort(sortByNumberOfOutliers);
                else
                    barchart_data.sort(sortByLabel);

                var width = 280,
                    barHeight = 20;

                var x = d3.scale.linear()
                    .domain([0, d3.max(barchart_data, function(d) { return d.number_of_outliers; })])
                    .range([0, width]);
           
                var linechart = d3.select(".barchart")
                    .attr("width", width)
                    .attr("height", barHeight * barchart_data.length);
                
                var linebars = linechart.selectAll("g")
                    .data(barchart_data)
                    .enter().append("g")
                    .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });

                linebars.append("rect")
                    .attr("width",  function(d) { return Math.max(70, x(d.number_of_outliers)); })
                    .attr("height", barHeight - 1)
                    .on("click", function(d, i) {selectLine(d, this);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this).style({opacity: '0.6'});
                                        })
                    .on("mouseout", function(d, i) {
                                        d3.select(this).style({opacity: '1.0'});
                                     });

                linebars.append("text")
                    .attr("x", function(d) { return (d.key).length * 5.5 + 2; })
                    .attr("y", barHeight / 2)
                    .attr("dy", ".35em")
                    .text(function(d) { return d.key; })
                    .on("click", function(d, i) {selectLine(d, this);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '0.6'});
                                        })
                    .on("mouseout", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '1.0'});
                                     });

                linebars.append("text")
                    .attr("x", function(d) { return Math.max(68, x(d.number_of_outliers) - 3); })
                    .attr("y", barHeight / 2)
                    .attr("dy", ".35em")
                    .text(function(d) { return d.number_of_outliers; })
                    .on("click", function(d, i) {selectLine(d, this);})
                    .on("mouseover", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '0.6'});
                                        })
                    .on("mouseout", function(d, i) {
                                        d3.select(this.parentNode).select("rect").style({opacity: '1.0'});
                                     });
            });
        }
        
        function containsHour(timestampstr){
            var ts = new Date(timestampstr.substring(0, 19).replace(" ", "T")+ "+0000");
            if ( (+ts.getUTCHours() in selectedHours)) { 
                return true;
            }
            return false;
        }
        
        function selectDay(d, refobj){
            d3.select(".vselected").style({fill: "steelblue"});
            d3.select(".vselected").classed("vselected", false);
            d3.select(refobj).classed("vselected", true);
            d3.select(refobj).style({fill: 'red'});
            fields = d.key.split("/");
            dateFileArray = [fields[1] + "-" + fields[0] + "-2013"];
            outliersfile = "outliers/" + fields[1] + "_" + fields[0] + ".csv";
            outliersfileArray = [outliersfile];
            selectedLines = [];
            selectedBusId = "";
            loadLstLines();
        }
        
        function selectLine(d, refobj){
            d3.select(".selectedLine").style({fill: "steelblue"});
            d3.select(".selectedLine").classed("selectedLine", false);
            d3.select(refobj).classed("selectedLine", true);
            d3.select(refobj).style({fill: 'red'});
            selectedLines = [d.key];
            selectedBusId = "";
            loadTimeBarChart();
            loadPtsOutliers(true);
            
        }
        
        function selectTime(hour){
            if(hour in selectedHours){
                delete selectedHours[hour];
            }else{
                selectedHours[hour] = 0;
            }
            colorTimeBars();
            loadPtsOutliers(true);
        }
        
        function selectBus(busid){
            $(".marker2").remove(); //remove paths between outliers
          
            for (var i=0; i<outlier_markers.length; i++){
                outlier_markers[i].each(transform2);
            }
            function transform2(d) {
                if (d.value['BusId'] == busid){
                    $("#outlierinfo").html("<b>Selected outlier:</b><br>"+
                            "<b>Start:</b> " + d.value['TimeStampStart'] + "<br>"+
                            "<b>End:</b>   " + d.value['TimeStampEnd'] + "<br>"+
                            "<b>Line:</b> " + d.value['Line'] + "<br>"+
                            "<b>Bus Id:</b> " + d.value['BusId']);
                    $("#outlierinfo").show();
                    
                    return d3.select(this).style("opacity", 1.0);
                }else{
                    return d3.select(this).style("opacity", "0.5");
                }
            }
            
            selectedBusId = busid; 
            loadPtsOutliers(false);
            loadPtsRaw(false, false);
            d3.select(".busselected").style({opacity: 0.4});
            d3.select(".busselected").classed("busselected", false);
            d3.select("#divBus"+busid).classed("busselected", true);
            d3.select("#divBus"+busid).style({opacity: 1.0});
            
			addOutlierPath();
        }
        
        function colorTimeBars(){
            for (i in d3.select("#timeBarchart").selectAll("rect")[0]){
                refobj = d3.select("#timeBarchart").selectAll("rect")[0][i];
                if (i in selectedHours){
                    d3.select(refobj).style({fill: "steelblue"});
                }else{
                    d3.select(refobj).style({fill: "lightgray"});
                }
            }

        }
            
        function format2digits(n){
            return n > 9 ? "" + n: "0" + n;
        }
        
        loadTimeBarChart();
        loadLstLines();
        
    </script>
</html>
